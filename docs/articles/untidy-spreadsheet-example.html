<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Untidy Spreadsheet Data • untidydata2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Untidy Spreadsheet Data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">untidydata2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gdp.html">Gross Domestic Product data</a>
    </li>
    <li>
      <a href="../articles/hypoxia.html">Hypoxia Data</a>
    </li>
    <li>
      <a href="../articles/journal_cost.html">Cost of publishing in journals</a>
    </li>
    <li>
      <a href="../articles/multievent.html">Preparing multiple event data for analysis</a>
    </li>
    <li>
      <a href="../articles/untidy-spreadsheet-example.html">Untidy Spreadsheet Data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Untidy Spreadsheet Data</h1>
                        <h4 class="author">David W. Body</h4>
            
            <h4 class="date">4/16/2019</h4>
      
      
      <div class="hidden name"><code>untidy-spreadsheet-example.Rmd</code></div>

    </div>

    
    
<div id="raw-data" class="section level1">
<h1 class="hasAnchor">
<a href="#raw-data" class="anchor"></a>Raw data</h1>
<p>This vignette is about working with an untidy spreadsheet of simulated sales data for a fictitious company with multiple locations in Indiana. The document presents several challenges we often encounter with real spreadsheets, including:</p>
<ul>
<li>Separate sheets (tabs) for groups in the data (in this case year)</li>
<li>Multiple header rows, including one with “merged cells”</li>
<li>Repeated headers within the same sheet</li>
<li>Number of columns varies by sheet</li>
</ul>
<p>The document contains 10 sheets (tabs), so coding them one-by-one isn’t very appealing. We’ll want to automate processing the sheets.</p>
<div id="manually-process-a-representative-sheet" class="section level3">
<h3 class="hasAnchor">
<a href="#manually-process-a-representative-sheet" class="anchor"></a>Manually process a representative sheet</h3>
<p>Before we create an automated solution, let’s start by manually processing a representative sheet so we can figure out what we need to automate.</p>
<p>Open the document in your favorite spreadsheet software and you’ll see that the first few sheets contain data for just one location, Noblesville. Later sheets contain data for more than one location. Sheet 7 (for 2016) looks like a good one to work with because it has data for multiple locations.</p>
<p>Notice that the location names are in cells that have been merged and centered, and there are price and quantity columns for each of the locations. Also notice that data for the last location, South Bend, is missing for the first several rows.</p>
<p><img src="untidy-spreadsheet.png"><!-- --></p>
<p>Let’s start by loading the <code>tidyverse</code> and <code>readxl</code> packages and setting <code>file_name</code> to the path to the spreadsheet. Since the spreadsheet is part of the <code>untidydata2</code> package, we use <code>system.file</code> to return a path to the spreadsheet.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a></code></pre></div>
<pre><code>## -- Attaching packages ---------------------------------- tidyverse 1.2.1 --</code></pre>
<pre><code>## v ggplot2 3.2.1     v purrr   0.3.2
## v tibble  2.1.3     v dplyr   0.8.3
## v tidyr   0.8.3     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.4.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------- tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(readxl)</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">file_name &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"messydata"</span>, <span class="st">"combined_sales.xlsx"</span>, <span class="dt">package=</span><span class="st">"untidydata2"</span>)</a></code></pre></div>
<p>First, let’s get a list of locations contained in sheet for 2016 using <code><a href="https://readxl.tidyverse.org/reference/read_excel.html">readxl::read_excel</a></code>. We can read just the first row by setting <code>n_max = 0</code> and then passing the result to <code>names</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> <span class="st">"2016"</span>, <span class="dt">n_max =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>()</a></code></pre></div>
<pre><code>## [1] "Noblesville" "...2"        "Bloomington" "...4"        "Muncie"     
## [6] "...6"        "South Bend"</code></pre>
<p>The merged cells are coming back with names of “…2”, “…4”, etc. We can remove them from the list with <code><a href="https://stringr.tidyverse.org/reference/str_subset.html">stringr::str_subset</a></code> and a regular expressing that matches “…” at the beginning of a string.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">locations &lt;-<span class="st"> </span><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> <span class="st">"2016"</span>, <span class="dt">n_max =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="st">  </span><span class="kw">str_subset</span>(<span class="st">"^</span><span class="ch">\\</span><span class="st">.{3}"</span>, <span class="dt">negate =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">locations</a></code></pre></div>
<pre><code>## [1] "Noblesville" "Bloomington" "Muncie"      "South Bend"</code></pre>
<p>Now we have a character vector of locations for the 2016 sheet. Let’s read the rest of the data from the 2016 sheet, skipping the first row this time.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> <span class="st">"2016"</span>, <span class="dt">skip =</span> <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 53 x 10
##    month   day price...3 quantity...4 price...5 quantity...6 price...7
##    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;
##  1     1     1      18.5        2764.      18.5        2631.      18.5
##  2     1     8      11.5        2751.      11.5        2788.      11.5
##  3     1    15      14.8        2612.      14.8        2989.      14.8
##  4     1    22      13.7        2723.      13.7        2827.      13.7
##  5     1    29      15.8        2764.      15.8        2804.      15.8
##  6     2     5      14.4        2369.      14.4        2932.      14.4
##  7     2    12      14.6        2931.      14.6        2706.      14.6
##  8     2    19      15.1        2317.      15.1        2948.      15.1
##  9     2    26      13.3        2479.      13.3        2683.      13.3
## 10     3     4      14.1        2967.      14.1        3017.      14.1
## # ... with 43 more rows, and 3 more variables: quantity...8 &lt;dbl&gt;,
## #   price...9 &lt;dbl&gt;, quantity...10 &lt;dbl&gt;</code></pre>
<p>We’re making progress but we need to do something to associate the <code>price...</code> and <code>quantity...</code> variables with their correct locations. Later we will want to have a separate variable for location, but for now let’s rename our <code>price</code> and <code>quantity</code> variables to <code>price_Noblesville</code>, <code>quantity_Noblesville</code>, <code>price_Bloomington</code>, <code>quantity_Bloomington</code>, etc.</p>
<p>Notice that <code>price...3</code> and <code>quantity...4</code> correspond to the first location, <code>price...5</code> and <code>quantity...6</code> correspond to the second location, etc. Let’s write a function to give us the corresponding location index for each value 3, 4, 5, 6, etc.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">loc_index &lt;-<span class="st"> </span><span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="kw"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>((n<span class="dv">-1</span>)<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-3" title="3">}</a></code></pre></div>
<p>Now let’s verify that this works.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">loc_index</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">10</span>)</a></code></pre></div>
<pre><code>## [1] 1 1 2 2 3 3 4 4</code></pre>
<p>Yes it does.</p>
<p>Now we can write a function to calculate a new name for each column we want to rename.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">new_name &lt;-<span class="st"> </span><span class="cf">function</span>(columns) {</a>
<a class="sourceLine" id="cb15-2" title="2">  num &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw">str_extract</span>(columns, <span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>))</a>
<a class="sourceLine" id="cb15-3" title="3">  location &lt;-<span class="st"> </span>locations[<span class="kw">loc_index</span>(num)]</a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="kw">str_replace</span>(columns, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"..."</span>, num), <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"_"</span>, location))</a>
<a class="sourceLine" id="cb15-5" title="5">}</a></code></pre></div>
<p>And let’s verify that this works.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">new_name</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"price...3"</span>, <span class="st">"quantity...4"</span>, <span class="st">"price...5"</span>, <span class="st">"quantity...6"</span>))</a></code></pre></div>
<pre><code>## [1] "price_Noblesville"    "quantity_Noblesville" "price_Bloomington"   
## [4] "quantity_Bloomington"</code></pre>
<p>Okay. Now we’re ready to read the spreadsheet and rename the columns.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">data_<span class="dv">2016</span> &lt;-<span class="st"> </span><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> <span class="st">"2016"</span>, <span class="dt">skip =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">  </span><span class="kw">rename_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">"..."</span>)), new_name)</a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4">data_<span class="dv">2016</span></a></code></pre></div>
<pre><code>## # A tibble: 53 x 10
##    month   day price_Noblesvil~ quantity_Nobles~ price_Bloomingt~
##    &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
##  1     1     1             18.5            2764.             18.5
##  2     1     8             11.5            2751.             11.5
##  3     1    15             14.8            2612.             14.8
##  4     1    22             13.7            2723.             13.7
##  5     1    29             15.8            2764.             15.8
##  6     2     5             14.4            2369.             14.4
##  7     2    12             14.6            2931.             14.6
##  8     2    19             15.1            2317.             15.1
##  9     2    26             13.3            2479.             13.3
## 10     3     4             14.1            2967.             14.1
## # ... with 43 more rows, and 5 more variables: quantity_Bloomington &lt;dbl&gt;,
## #   price_Muncie &lt;dbl&gt;, quantity_Muncie &lt;dbl&gt;, `price_South Bend` &lt;dbl&gt;,
## #   `quantity_South Bend` &lt;dbl&gt;</code></pre>
</div>
<div id="the-trickiest-part-of-tidying-this-data" class="section level3">
<h3 class="hasAnchor">
<a href="#the-trickiest-part-of-tidying-this-data" class="anchor"></a>The trickiest part of tidying this data</h3>
<p>Finally, let’s extract location, price, and quantity variables. This is the trickiest part of tidying this data because it involves gathering multiple variables and then spreading them again. We also add the year and order the variables.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">data_<span class="dv">2016</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span><span class="kw">gather</span>(<span class="op">-</span>month, <span class="op">-</span>day, <span class="dt">key =</span> <span class="st">"label"</span>, <span class="dt">value =</span> <span class="st">"value"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span><span class="kw">separate</span>(label, <span class="dt">into =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"type"</span>, <span class="st">"location"</span>), <span class="dt">sep =</span> <span class="st">"_"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> <span class="st">"type"</span>, <span class="dt">value =</span> <span class="st">"value"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(price) <span class="op">|</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(quantity)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="dv">2016</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="st">  </span><span class="kw">select</span>(year, month, day, location, price, quantity)</a></code></pre></div>
<pre><code>## # A tibble: 194 x 6
##     year month   day location    price quantity
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
##  1  2016     1     1 Bloomington  18.5    2631.
##  2  2016     1     1 Muncie       18.5    2928.
##  3  2016     1     1 Noblesville  18.5    2764.
##  4  2016     1     8 Bloomington  11.5    2788.
##  5  2016     1     8 Muncie       11.5    3162.
##  6  2016     1     8 Noblesville  11.5    2751.
##  7  2016     1    15 Bloomington  14.8    2989.
##  8  2016     1    15 Muncie       14.8    2986.
##  9  2016     1    15 Noblesville  14.8    2612.
## 10  2016     1    22 Bloomington  13.7    2827.
## # ... with 184 more rows</code></pre>
<p>Whoa, there is a lot going on there! Let’s do that again and look at the intermediate results.</p>
</div>
<div id="one-more-time-with-intermediate-results" class="section level3">
<h3 class="hasAnchor">
<a href="#one-more-time-with-intermediate-results" class="anchor"></a>One more time with intermediate results</h3>
<p>First we gather the location/price/quantity columns into <code>label</code> and <code>value</code> variables.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">step1 &lt;-<span class="st"> </span>data_<span class="dv">2016</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="kw">gather</span>(<span class="op">-</span>month, <span class="op">-</span>day, <span class="dt">key =</span> <span class="st">"label"</span>, <span class="dt">value =</span> <span class="st">"value"</span>)</a>
<a class="sourceLine" id="cb22-3" title="3"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(step1)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   month   day label             value
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;
## 1     1     1 price_Noblesville  18.5
## 2     1     8 price_Noblesville  11.5
## 3     1    15 price_Noblesville  14.8
## 4     1    22 price_Noblesville  13.7
## 5     1    29 price_Noblesville  15.8
## 6     2     5 price_Noblesville  14.4</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(step1)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   month   day label               value
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;
## 1    11    25 quantity_South Bend 3038.
## 2    12     2 quantity_South Bend 3188.
## 3    12     9 quantity_South Bend 3265.
## 4    12    16 quantity_South Bend 3487.
## 5    12    23 quantity_South Bend 2849.
## 6    12    30 quantity_South Bend 3050.</code></pre>
<p>Then we can separate <code>location</code> into its own variable, while maintaining a <code>type</code> variable to distinguish <code>price</code> and <code>quantity</code>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">step2 &lt;-<span class="st"> </span>step1 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="st">  </span><span class="kw">separate</span>(label, <span class="dt">into =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"type"</span>, <span class="st">"location"</span>), <span class="dt">sep =</span> <span class="st">"_"</span>)</a>
<a class="sourceLine" id="cb26-3" title="3"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(step2)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   month   day type  location    value
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1     1     1 price Noblesville  18.5
## 2     1     8 price Noblesville  11.5
## 3     1    15 price Noblesville  14.8
## 4     1    22 price Noblesville  13.7
## 5     1    29 price Noblesville  15.8
## 6     2     5 price Noblesville  14.4</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(step2)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   month   day type     location   value
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
## 1    11    25 quantity South Bend 3038.
## 2    12     2 quantity South Bend 3188.
## 3    12     9 quantity South Bend 3265.
## 4    12    16 quantity South Bend 3487.
## 5    12    23 quantity South Bend 2849.
## 6    12    30 quantity South Bend 3050.</code></pre>
<p>Now we can move <code>price</code> and <code>quantity</code> into their own variables using <code><a href="https://tidyr.tidyverse.org/reference/spread.html">tidyr::spread</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">step3 &lt;-<span class="st"> </span>step2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> <span class="st">"type"</span>, <span class="dt">value =</span> <span class="st">"value"</span>)</a>
<a class="sourceLine" id="cb30-3" title="3">step3</a></code></pre></div>
<pre><code>## # A tibble: 212 x 5
##    month   day location    price quantity
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
##  1     1     1 Bloomington  18.5    2631.
##  2     1     1 Muncie       18.5    2928.
##  3     1     1 Noblesville  18.5    2764.
##  4     1     1 South Bend   NA        NA 
##  5     1     8 Bloomington  11.5    2788.
##  6     1     8 Muncie       11.5    3162.
##  7     1     8 Noblesville  11.5    2751.
##  8     1     8 South Bend   NA        NA 
##  9     1    15 Bloomington  14.8    2989.
## 10     1    15 Muncie       14.8    2986.
## # ... with 202 more rows</code></pre>
<p>Finally, we filter out NA values, add the year, and reorder the variables.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">step3 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(price) <span class="op">|</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(quantity)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="dv">2016</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-4" title="4"><span class="st">  </span><span class="kw">select</span>(year, month, day, location, price, quantity)</a></code></pre></div>
<pre><code>## # A tibble: 194 x 6
##     year month   day location    price quantity
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
##  1  2016     1     1 Bloomington  18.5    2631.
##  2  2016     1     1 Muncie       18.5    2928.
##  3  2016     1     1 Noblesville  18.5    2764.
##  4  2016     1     8 Bloomington  11.5    2788.
##  5  2016     1     8 Muncie       11.5    3162.
##  6  2016     1     8 Noblesville  11.5    2751.
##  7  2016     1    15 Bloomington  14.8    2989.
##  8  2016     1    15 Muncie       14.8    2986.
##  9  2016     1    15 Noblesville  14.8    2612.
## 10  2016     1    22 Bloomington  13.7    2827.
## # ... with 184 more rows</code></pre>
<p>This looks good, but it’s just one sheet. Now let’s write some code to process the whole spreadsheet document.</p>
</div>
<div id="a-function-to-read-any-specified-sheet-from-the-document" class="section level3">
<h3 class="hasAnchor">
<a href="#a-function-to-read-any-specified-sheet-from-the-document" class="anchor"></a>A function to read any specified sheet from the document</h3>
<p>Here is a function that combines everything we’ve done above to read any specified sheet from the document. It also handles the simpler special case when a sheet contains only a single location.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">read_sheet &lt;-<span class="st"> </span><span class="cf">function</span>(file_name, sheet) {</a>
<a class="sourceLine" id="cb34-2" title="2">  locations &lt;-<span class="st"> </span><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> sheet, <span class="dt">n_max =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-4" title="4"><span class="st">    </span><span class="kw">str_subset</span>(<span class="st">"^</span><span class="ch">\\</span><span class="st">.{3}"</span>, <span class="dt">negate =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb34-5" title="5"></a>
<a class="sourceLine" id="cb34-6" title="6">  df &lt;-<span class="st"> </span><span class="kw">read_excel</span>(file_name, <span class="dt">sheet =</span> sheet, <span class="dt">skip =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb34-7" title="7">  </a>
<a class="sourceLine" id="cb34-8" title="8">  <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(locations) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb34-9" title="9">    df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-10" title="10"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">location =</span> locations[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb34-11" title="11">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb34-12" title="12">    loc_index &lt;-<span class="st"> </span><span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb34-13" title="13">      <span class="kw"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>((n<span class="dv">-1</span>)<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb34-14" title="14">    }</a>
<a class="sourceLine" id="cb34-15" title="15">    </a>
<a class="sourceLine" id="cb34-16" title="16">    new_name &lt;-<span class="st"> </span><span class="cf">function</span>(columns) {</a>
<a class="sourceLine" id="cb34-17" title="17">      num &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw">str_extract</span>(columns, <span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>))</a>
<a class="sourceLine" id="cb34-18" title="18">      location &lt;-<span class="st"> </span>locations[<span class="kw">loc_index</span>(num)]</a>
<a class="sourceLine" id="cb34-19" title="19">      <span class="kw">str_replace</span>(columns, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"..."</span>, num), <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"_"</span>, location))</a>
<a class="sourceLine" id="cb34-20" title="20">    }</a>
<a class="sourceLine" id="cb34-21" title="21">    </a>
<a class="sourceLine" id="cb34-22" title="22">    df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-23" title="23"><span class="st">      </span><span class="kw">rename_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">"..."</span>)), new_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-24" title="24"><span class="st">      </span><span class="kw">gather</span>(<span class="op">-</span>month, <span class="op">-</span>day, <span class="dt">key =</span> <span class="st">"label"</span>, <span class="dt">value =</span> <span class="st">"value"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-25" title="25"><span class="st">      </span><span class="kw">separate</span>(label, <span class="dt">into =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"type"</span>, <span class="st">"location"</span>), <span class="dt">sep =</span> <span class="st">"_"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-26" title="26"><span class="st">      </span><span class="kw">spread</span>(<span class="dt">key =</span> <span class="st">"type"</span>, <span class="dt">value =</span> <span class="st">"value"</span>)</a>
<a class="sourceLine" id="cb34-27" title="27">  }</a>
<a class="sourceLine" id="cb34-28" title="28">  </a>
<a class="sourceLine" id="cb34-29" title="29">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-30" title="30"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(price) <span class="op">|</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(quantity)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-31" title="31"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(sheet)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-32" title="32"><span class="st">    </span><span class="kw">select</span>(year, month, day, location, price, quantity)</a>
<a class="sourceLine" id="cb34-33" title="33"></a>
<a class="sourceLine" id="cb34-34" title="34">  df</a>
<a class="sourceLine" id="cb34-35" title="35">}</a>
<a class="sourceLine" id="cb34-36" title="36"></a>
<a class="sourceLine" id="cb34-37" title="37"><span class="kw">read_sheet</span>(file_name, <span class="st">"2016"</span>)</a></code></pre></div>
<pre><code>## # A tibble: 194 x 6
##     year month   day location    price quantity
##    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
##  1  2016     1     1 Bloomington  18.5    2631.
##  2  2016     1     1 Muncie       18.5    2928.
##  3  2016     1     1 Noblesville  18.5    2764.
##  4  2016     1     8 Bloomington  11.5    2788.
##  5  2016     1     8 Muncie       11.5    3162.
##  6  2016     1     8 Noblesville  11.5    2751.
##  7  2016     1    15 Bloomington  14.8    2989.
##  8  2016     1    15 Muncie       14.8    2986.
##  9  2016     1    15 Noblesville  14.8    2612.
## 10  2016     1    22 Bloomington  13.7    2827.
## # ... with 184 more rows</code></pre>
<p>The hard part is done. Now let’s read and combine all the sheets.</p>
</div>
<div id="reading-all-the-sheets-into-one-tidy-data-frame" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-all-the-sheets-into-one-tidy-data-frame" class="anchor"></a>Reading all the sheets into one tidy data frame</h3>
<p>Start with a vector of sheet names for the spreadsheet document.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">sheets &lt;-<span class="st"> </span><span class="kw">excel_sheets</span>(file_name)</a>
<a class="sourceLine" id="cb36-2" title="2">sheets</a></code></pre></div>
<pre><code>##  [1] "2010" "2011" "2012" "2013" "2014" "2015" "2016" "2017" "2018" "2019"</code></pre>
<p>Now we use <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map_dfr</a></code> to read a data frame for each sheet and combine them into a single data frame.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1">combined_df &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(sheets, <span class="op">~</span><span class="st"> </span><span class="kw">read_sheet</span>(file_name, .x))</a>
<a class="sourceLine" id="cb38-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(combined_df)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##    year month   day location    price quantity
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
## 1  2010     1     1 Noblesville  7.65    2530.
## 2  2010     1     8 Noblesville 12.8     2342.
## 3  2010     1    15 Noblesville 10.0     2403.
## 4  2010     1    22 Noblesville 12.5     2265.
## 5  2010     1    29 Noblesville 11.8     2312.
## 6  2010     2     5 Noblesville  6.15    2583.</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(combined_df)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##    year month   day location    price quantity
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;
## 1  2019     4     5 South Bend   18.9    3572.
## 2  2019     4    12 Bloomington  20.3    2874.
## 3  2019     4    12 Fort Wayne   20.3    3062.
## 4  2019     4    12 Muncie       20.3    3371.
## 5  2019     4    12 Noblesville  20.3    2361.
## 6  2019     4    12 South Bend   20.3    2670.</code></pre>
<p>At least the last step was easy!</p>
<p>We now have a tidy data frame containing all of the data from the spreadsheet.</p>
</div>
<div id="bonus-material-simpsons-paradox" class="section level2">
<h2 class="hasAnchor">
<a href="#bonus-material-simpsons-paradox" class="anchor"></a>Bonus material: Simpson’s Paradox</h2>
<p>The main point of this vignette is to show how to tidy data an untidy spreadsheet. But let’s take just a few more minutes to look at the data.</p>
<p>First, let’s plot <code>price</code> and <code>quantity</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1">combined_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(price, quantity)) <span class="op">+</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>)</a></code></pre></div>
<p><img src="untidy-spreadsheet-example_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Based on this plot, it appears higher prices are associated with greater quantities sold. Should management consider raising prices? Based on this plot, it doesn’t look like higher prices would cause reduced sales.</p>
<p>However, if we look at individual locations, we see something quite different.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">combined_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-2" title="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(price, quantity)) <span class="op">+</span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb43-4" title="4"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>location)</a></code></pre></div>
<p><img src="untidy-spreadsheet-example_files/figure-html/unnamed-chunk-20-1.png" width="576"></p>
<p>When locations are considered separately, higher prices are associated with lower quantities sold, as we would normally expect. The only exception appears to be Noblesville. Noblesville is this fictitious company’s oldest location. We have data for Noblesville from 2010 to the present.</p>
<p>Let’s look at Noblesville by year.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">combined_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(location <span class="op">==</span><span class="st"> "Noblesville"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-3" title="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(price, quantity)) <span class="op">+</span></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb44-5" title="5"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb44-6" title="6"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>year)</a></code></pre></div>
<p><img src="untidy-spreadsheet-example_files/figure-html/unnamed-chunk-21-1.png" width="576"></p>
<p>So higher prices are associated with lower quantities even for Noblesville if we look at shorter time periods like a year.</p>
<p>This phenomenon where an association appears to exist in data as a whole, but disappears or even reverses when groups are analyzed separately, is known as <a href="https://en.wikipedia.org/wiki/Simpson's_paradox">Simpson’s Paradox</a>. You can read more about at the link.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#raw-data">Raw data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#bonus-material-simpsons-paradox">Bonus material: Simpson’s Paradox</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by David Body, Giorgi Chighladze, Anne Eaton, Kevin Wright.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
